name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-8-jdk git zip unzip build-essential libffi-dev libssl-dev

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install buildozer cython

    - name: Create simple buildozer.spec
      run: |
        cat > buildozer.spec << 'EOF'
        [app]
        title = CryptoKeyFinder
        package.name = cryptokeyfinder
        package.domain = org.test
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 1.0
        requirements = python3,kivy
        orientation = portrait
        fullscreen = 0

        [buildozer]
        log_level = 1
        warn_on_root = 0
        android.api = 28
        android.minapi = 21
        android.archs = arm64-v8a
        EOF

    - name: Build APK
      run: |
        export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        buildozer android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: CryptoKeyFinder-APK
        path: |
          bin/*.apk
          .buildozer/android/platform/build-*/dists/*/bin/*.apk
